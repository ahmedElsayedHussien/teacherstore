{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 m-0">إدارة طلاب المجموعة: {{ group.name }}</h1>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'core:teacher_groups' %}">رجوع</a>
  </div>

  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags }}">{{ m }}</div>
    {% endfor %}
  {% endif %}

  
    
  <!-- البلوك الجديد: اختيار من الطلاب المتاحين -->
  <div class="card p-3 mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0">إضافة من قائمة الطلاب المتاحين</h2>
      <small class="text-muted">بحد أقصى 200 نتيجة.</small>
    </div>

    <!-- فلاتر -->
    <form method="get" class="row g-2 mb-2">
      <div class="col-md-5">
        <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm" placeholder="ابحث بالاسم/الهاتف/الإيميل…">
      </div>
      <div class="col-md-4">
        <div class="form-check mt-1">
          <input class="form-check-input" type="checkbox" value="1" id="onlyFree"
                 name="only_free" {% if only_free == "1" %}checked{% endif %}>
          <label class="form-check-label" for="onlyFree">
            عرض فقط الطلاب غير المنتسبين لأي مجموعة نشِطة
          </label>
        </div>
      </div>
      <div class="col-md-3 text-end">
        <button class="btn btn-outline-secondary btn-sm">تطبيق الفلاتر</button>
      </div>
    </form>

    <form method="post" id="pickForm">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_picked">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th style="width:36px">
                <input type="checkbox" id="pickAll" onclick="toggleAll(this)">
              </th>
              <th>الطالب</th>
              <th>الهاتف</th>
              <th>الإيميل</th>
            </tr>
          </thead>
          <tbody>
            {% for st in available_students %}
            <tr>
              <td><input type="checkbox" name="pick" value="{{ st.id }}"></td>
              <td>{{ st.first_name }} {{ st.last_name }}</td>
              <td>{{ st.phone|default:"—" }}</td>
              <td>{{ st.email|default:"—" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center text-muted">لا نتائج مطابقة للفلاتر.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-end">
        <button class="btn btn-primary btn-sm">إضافة المحدّدين</button>
      </div>
    </form>
  </div>

  <!-- أعضاء المجموعة الحاليون -->
  <div class="card p-3 mt-3">
    <h2 class="h6 mb-2">طلاب المجموعة</h2>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead><tr><th>#</th><th>الطالب</th><th>الهاتف</th><th>الإيميل</th><th class="text-end">إزالة</th></tr></thead>
        <tbody>
          {% for enr in members %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ enr.student.first_name }} {{ enr.student.last_name }}</td>
            <td>{{ enr.student.phone|default:"—" }}</td>
            <td>{{ enr.student.email|default:"—" }}</td>
            <td class="text-end">
              <form method="post" class="d-inline" onsubmit="return confirm('إزالة الطالب من المجموعة؟')">
                {% csrf_token %}
                <input type="hidden" name="action" value="remove">
                <input type="hidden" name="enrollment_id" value="{{ enr.id }}">
                <button class="btn btn-sm btn-outline-danger">إزالة</button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center text-muted">لا يوجد طلاب بعد.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
function toggleAll(master){
  document.querySelectorAll('input[name="pick"]').forEach(cb => cb.checked = master.checked);
}
</script>
{% endblock %}
