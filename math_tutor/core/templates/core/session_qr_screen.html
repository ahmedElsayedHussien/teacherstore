{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>QR حضور الحصة</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body{background:#f8fafc}
    .card{border:0;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .qr-box{display:flex;align-items:center;justify-content:center;min-height:260px;background:#0b1020;border-radius:12px}
    .qr-box img{max-width:240px;max-height:240px}
    .muted{color:#64748b}
    code.small{font-size:.9rem}
  </style>
</head>
<body class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h5 m-0">رمز حضور الحصة</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'core:dashboard' %}">رجوع للوحة المدرّس</a>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <div class="row g-3">
      <div class="col-lg-5">
        <div class="qr-box mb-2">
          <!-- نحدّث الـ src جافاسكربت -->
          <img id="qrImg" alt="QR" src="" />
        </div>
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small muted">ينتهي خلال</div>
            <div class="fw-bold"><span id="countdown">—</span> ثانية</div>
          </div>
          <form id="refreshForm" method="post" class="d-inline">
            {% csrf_token %}
            <button id="refreshBtn" class="btn btn-sm btn-outline-primary" type="submit">تحديث يدوي</button>
          </form>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="mb-2">
          <div class="small muted">المجموعة</div>
          <div class="fw-bold">{{ session.group.name }}</div>
        </div>
        <div class="mb-2">
          <div class="small muted">التاريخ والوقت</div>
          <div class="fw-bold">{{ session.date }} — {{ session.start_time }}–{{ session.end_time }}</div>
        </div>
        <div class="mb-2">
          <div class="small muted">الموضوع</div>
          <div class="fw-bold">{% if session.topic %}{{ session.topic }}{% else %}<span class="text-muted">—</span>{% endif %}</div>
        </div>

        <hr>

        <div class="mb-2">
          <div class="small muted">رابط صفحة المسح (للمسؤول/المشرف)</div>
          <div class="d-flex align-items-center gap-2">
            <a id="scanLink" class="btn btn-sm btn-outline-dark" href="{% url 'core:attendance_scan' session.id %}" target="_blank" rel="noopener">فتح صفحة المسح</a>
            <code class="small text-break">{% url 'core:attendance_scan' session.id %}</code>
          </div>
          <div class="small text-muted mt-1">الطلاب يكتفون بمسح الـ QR من شاشتك، ما يحتاجون هذا الرابط.</div>
        </div>

        <div class="alert alert-info mt-3 mb-0">
          <div class="fw-bold mb-1">تنبيه</div>
          <div class="small m-0">
            رمز الـ QR يتغيّر كل دقيقة لأمان أعلى. لو خلص العدّاد، يتحدّث تلقائيًا.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const refreshUrl = "{% url 'core:session_qr_refresh' session.id %}";
  const csrftoken = (function(){
    const el = document.querySelector('#refreshForm input[name=csrfmiddlewaretoken]');
    return el ? el.value : '';
  })();

  const imgEl = document.getElementById('qrImg');
  const cdEl  = document.getElementById('countdown');
  const form  = document.getElementById('refreshForm');
  const btn   = document.getElementById('refreshBtn');

  let expiresAt = null;   // ISO string
  let timerId = null;

  async function fetchQR(manual=false){
    try{
      if(manual){ btn.disabled = true; }
      const resp = await fetch(refreshUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
      });
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const data = await resp.json();

      if(data.png_base64){
        imgEl.src = 'data:image/png;base64,' + data.png_base64;
      }
      if(data.expires_at){
        expiresAt = new Date(data.expires_at); // ISO
      }
      // (اختياري) لو رجّعنا scan_url للعرض
      // if(data.scan_url){ document.getElementById('scanLink').href = data.scan_url; }

      tick(); // يبدأ/يحدّث العدّاد
    }catch(e){
      console.error(e);
      cdEl.textContent = 'خطأ بالتحديث';
    }finally{
      if(manual){ btn.disabled = false; }
    }
  }

  function tick(){
    if(timerId){ clearInterval(timerId); }
    timerId = setInterval(()=>{
      if(!expiresAt){
        cdEl.textContent = '—';
        return;
      }
      const now = new Date();
      const diff = Math.max(0, Math.floor((expiresAt - now)/1000));
      cdEl.textContent = diff.toString();

      // لو بقي <= 5 ثواني، جهّز تحديث جديد قبل الانتهاء
      if(diff <= 5){
        clearInterval(timerId);
        fetchQR(false);
      }
    }, 500);
  }

  form.addEventListener('submit', function(ev){
    ev.preventDefault();
    fetchQR(true);
  });

  // أول تحميل
  fetchQR(false);
})();
</script>

</body>
</html>
