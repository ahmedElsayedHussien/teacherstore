{% extends "base.html" %}
{% load static %}
{% load misc %}

{% block title %}Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨{% endblock %}

{% block content %}
<style>
  body{background:#f7fafc}
  .kpi{
    border-radius:12px;
    background:#eef2ff;        /* ÙØ§ØªØ­ */
    color:#0f172a;              /* Ù†Øµ Ø¯Ø§ÙƒÙ† */
    padding:14px;
  }
  .kpi .num{font-weight:700;font-size:18px}
  .card{border:0;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.06)}
  .muted{color:#64748b}
  .badge{font-weight:600}
</style>

<div class="container py-4">

  <!-- Ù‡ÙŠØ¯Ø± -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h5 m-0">Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ student.first_name }} ğŸ‘‹</h1>
    <div class="d-flex gap-2">
      <form method="post" action="{% url 'core:logout' %}" class="d-inline">{% csrf_token %}
        <button class="btn btn-outline-secondary btn-sm" type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </form>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'core:account_profile' %}">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</a>
    </div>
  </div>

  <!-- Ø±Ø³Ø§Ø¦Ù„ -->
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- KPIs -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3"><div class="kpi text-center">
      <div class="small text-muted">ÙˆØ§Ø¬Ø¨Ø§Øª Ù…ÙØªÙˆØ­Ø©</div><div class="num">{{ open_assignments|length }}</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="kpi text-center">
      <div class="small text-muted">Ø­ØµØµ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div><div class="num">{{ upcoming_sessions|length }}</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="kpi text-center">
      <div class="small text-muted">Ø¢Ø®Ø± ØªØ³Ù„ÙŠÙ…Ø§Øª</div><div class="num">{{ recent_submissions|length }}</div>
    </div></div>
    <div class="col-6 col-md-3"><div class="kpi text-center">
      <div class="small text-muted">Ù…ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÙŠØ¯Ø©</div><div class="num">{{ recent_resources|length }}</div>
    </div></div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-assignments" type="button">ÙˆØ§Ø¬Ø¨Ø§ØªÙŠ</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-schedule" type="button">Ø¬Ø¯ÙˆÙ„ Ø­ØµØµÙŠ</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-submissions" type="button">ØªØ³Ù„ÙŠÙ…Ø§ØªÙŠ ÙˆÙ†ØªØ§Ø¦Ø¬ÙŠ</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-resources" type="button">Ù…ÙˆØ§Ø±Ø¯</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-checkin" type="button">Ø§Ù„Ø­Ø¶ÙˆØ± (QR)</button></li>
  </ul>

  <div class="tab-content">

    <!-- ÙˆØ§Ø¬Ø¨Ø§ØªÙŠ -->
    <div class="tab-pane fade show active" id="tab-assignments">
      <div class="card p-3">
        <h2 class="h6 mb-3">Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th>
                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                <th>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ù†ØªÙŠØ¬ØªÙŠ</th>
                <th class="text-end">ØªØ³Ù„ÙŠÙ…</th>
              </tr>
            </thead>
            <tbody>
              {% for a in open_assignments %}
                {% with mysub=subs_map|get_item:a.id %}
                <tr>
                  <td>{{ a.title }}</td>
                  <td>{{ a.group.name }}</td>
                  <td>{% if a.subject %}{{ a.subject.name }}{% elif a.group.subject %}{{ a.group.subject.name }}{% else %}â€”{% endif %}</td>
                  <td>{% if a.due_at %}{{ a.due_at|date:"Y-m-d H:i" }}{% else %}<span class="text-muted">â€”</span>{% endif %}</td>

                  <td>
                    {% if mysub %}
                      <span class="badge bg-success">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
                      {% if mysub.status == "LATE" %}
                        <span class="badge bg-warning text-dark">Ù…ØªØ£Ø®Ø±</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">Ù„Ù… ÙŠÙØ³Ù„Ù‘ÙÙ… Ø¨Ø¹Ø¯</span>
                      {% if a.due_at and a.due_at|date:"U" < now_ts %}
                        <span class="badge bg-warning text-dark">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª</span>
                      {% endif %}
                    {% endif %}
                  </td>

                  <td>
                    {% if mysub and mysub.grade != None %}
                      <span class="badge bg-primary">Ø§Ù„Ø¯Ø±Ø¬Ø©: {{ mysub.grade }}</span>
                      {% if mysub.feedback %}
                        <span class="badge bg-info text-dark">ØªØ¹Ù„ÙŠÙ‚ Ù…ØªØ§Ø­</span>
                      {% endif %}
                    {% elif mysub %}
                      <span class="badge bg-light text-dark">Ù‚ÙŠØ¯ Ø§Ù„ØªØµØ­ÙŠØ­</span>
                    {% else %}
                      <span class="text-muted">â€”</span>
                    {% endif %}
                  </td>

                  <td class="text-end">
                    {% if mysub %}
                      <a class="btn btn-sm btn-outline-primary" href="{% url 'core:student_submission_view' mysub.id %}">Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ù„ÙŠÙ…</a>
                    {% else %}
                      <a class="btn btn-sm btn-success" href="{% url 'core:student_assignment_submit' a.id %}">Ø³Ù„Ù‘Ù… Ø§Ù„Ø¢Ù†</a>
                    {% endif %}
                  </td>
                </tr>
                {% endwith %}
              {% empty %}
                <tr><td colspan="7" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø­ØµØµÙŠ -->
    <div class="tab-pane fade" id="tab-schedule">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 m-0">Ù…Ù† {{ today }} Ø¥Ù„Ù‰ {{ next_week }}</h2>
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù†Ù…Ø·</th></tr></thead>
            <tbody>
              {% for s in upcoming_sessions %}
              <tr>
                <td>{{ s.date }}</td>
                <td>{{ s.start_time }}â€“{{ s.end_time }}</td>
                <td>{{ s.group.name }}</td>
                <td>{% if s.subject %}{{ s.subject.name }}{% elif s.group.subject %}{{ s.group.subject.name }}{% else %}â€”{% endif %}</td>
                <td>{% if s.is_online %}<span class="badge bg-success">Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</span>{% else %}<span class="badge bg-secondary">Ø­Ø¶ÙˆØ±ÙŠ</span>{% endif %}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-center text-muted">Ù„Ø§ Ø­ØµØµ Ù‚Ø§Ø¯Ù…Ø© Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ØªØ³Ù„ÙŠÙ…Ø§ØªÙŠ ÙˆÙ†ØªØ§Ø¦Ø¬ÙŠ -->
    <div class="tab-pane fade" id="tab-submissions">
      <div class="card p-3">
        <h2 class="h6 mb-2">Ø¢Ø®Ø± Ø§Ù„ØªØ³Ù„ÙŠÙ…Ø§Øª</h2>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Ø§Ù„ÙˆØ§Ø¬Ø¨</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…</th><th></th></tr></thead>
            <tbody>
              {% for sub in recent_submissions %}
              <tr>
                <td>{{ sub.assignment.title }}</td>
                <td>{{ sub.assignment.group.name }}</td>
                <td>
                  {% if sub.status == "GRADED" %}<span class="badge bg-success">Ù…ØµØ­Ù‘Ø­</span>
                  {% elif sub.status == "LATE" %}<span class="badge bg-warning text-dark">Ù…ØªØ£Ø®Ø±</span>
                  {% else %}<span class="badge bg-secondary">Ù…Ø³Ù„Ù‘Ù…</span>{% endif %}
                </td>
                <td>{% if sub.grade != None %}{{ sub.grade }}{% else %}<span class="text-muted">â€”</span>{% endif %}</td>
                <td>{{ sub.submitted_at|date:"Y-m-d H:i" }}</td>
                <td><a class="btn btn-sm btn-outline-primary" href="{% url 'core:student_submission_view' sub.id %}">Ø¹Ø±Ø¶</a></td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="text-center text-muted">Ù„Ø³Ù‡ Ù…Ø§ Ø³Ù„Ù‘Ù…Øª Ø´ÙŠ.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ù…ÙˆØ§Ø±Ø¯ -->
    <div class="tab-pane fade" id="tab-resources">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h6 m-0">Ù…ÙˆØ§Ø±Ø¯ Ø­Ø¯ÙŠØ«Ø©</h2>
          <small class="text-muted">Ø¢Ø®Ø± {{ recent_resources|length }} Ù…ÙˆØ±Ø¯</small>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© / Ø§Ù„Ø­ØµØ©</th>
                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                <th>ØªØ§Ø±ÙŠØ®</th>
                <th class="text-end">Ø±Ø§Ø¨Ø· / Ù…Ù„Ù</th>
              </tr>
            </thead>
            <tbody>
              {% for r in recent_resources %}
              <tr>
                <td>{{ r.title }}</td>
                <td>{{ r.get_kind_display }}</td>
                <td>
                  {% if r.session %}
                    {{ r.session.group.name }} <span class="text-muted">/ {{ r.session.date }}</span>
                  {% elif r.group %}
                    {{ r.group.name }}
                  {% else %} â€” {% endif %}
                </td>
                <td>{% if r.subject %}{{ r.subject.name }}{% else %}â€”{% endif %}</td>
                <td>{{ r.created_at|date:"Y-m-d H:i" }}</td>
                <td class="text-end">
                  {% if r.url %}
                    <a class="btn btn-sm btn-outline-primary" href="{{ r.url }}" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</a>
                  {% endif %}
                  {% if r.file %}
                    <a class="btn btn-sm btn-outline-secondary" href="{{ r.file.url }}" target="_blank" rel="noopener">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a>
                  {% endif %}
                  {% if not r.url and not r.file %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="text-center text-muted">Ù…Ø§ ÙÙŠ Ù…ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÙŠØ¯Ø©.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø­Ø¶ÙˆØ± (QR) -->
    <div class="tab-pane fade" id="tab-checkin">
      <div class="card p-3">
        <h2 class="h6 mb-3">Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„Ø­Ø¶ÙˆØ±</h2>
        <div id="reader" style="max-width:420px"></div>
        <div class="small text-muted mt-2">Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ø«Ù… ÙˆØ¬Ù‘Ù‡Ù‡Ø§ Ù†Ø­Ùˆ QR Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø¯Ø±Ù‘Ø³.</div>
      </div>
    </div>

  </div>
</div>

<!-- Ù…Ø§Ø³Ø­ QR -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  const tabButton = document.querySelector('[data-bs-target="#tab-checkin"]');
  const el = document.getElementById("reader");
  if(!tabButton || !el) return;

  let html5QrCode = null;

  function startScanner(){
    if(html5QrCode) return; // already started
    html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(cameras => {
      const camId = (cameras && cameras.length) ? cameras[0].id : null;
      if(!camId){ el.innerHTML = '<div class="text-danger">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªØ§Ø­Ø©.</div>'; return; }
      html5QrCode.start(
        camId,
        { fps: 10, qrbox: 250 },
        function onScanSuccess(decodedText){
          try{
            if(decodedText.startsWith("http")){
              window.location.href = decodedText;
            }else{
              window.location.href = decodedText;
            }
          }catch(e){
            console.error(e);
            alert("ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ù…Ø². Ø¬Ø±Ù‘Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
          }
        },
        function onScanFailure(_e){ /* ignore */ }
      );
    }).catch(err => {
      console.error(err);
      el.innerHTML = '<div class="text-danger">ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.</div>';
    });
  }

  // Ø´ØºÙ‘Ù„ Ø§Ù„Ù…Ø§Ø³Ø­ Ø£ÙˆÙ„ Ù…Ø§ ÙŠÙØªØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø¶ÙˆØ±
  tabButton.addEventListener("shown.bs.tab", startScanner);
});
</script>
{% endblock %}
